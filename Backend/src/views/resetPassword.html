<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Restablecer Contraseña</title>
    <link rel="icon" href="/assets/candado.png" />
    <link rel="stylesheet" href="/views/views.css" />
  </head>
  <body class="fondo-sucess">
    <!-- Spinner de carga -->
    <div id="spinnerOverlay" class="spinner-overlay" style="display: none">
      <div class="cont-popUp cont-spinner">
        <div class="loader"></div>
        <button class="btn-hiden" type="button"></button>
      </div>
    </div>

    <form id="resetForm" method="POST" class="form-reset">
      <img src="/assets/candadoForgot.png" alt="" />
      <h2>Restablecer Contraseña</h2>
      <!-- Aquí aparecerá el mensaje de error -->
      <p id="errorMsg" class="error-msg" style="display: none"></p>

      <div>
        <img src="/assets/llave.png" alt="" />
        <input
          type="password"
          id="password"
          name="password"
          placeholder="Nueva contraseña"
          required
        />
      </div>
      <button type="submit" id="submitBtn" title="Actualizar contraseña">
        Actualizar
      </button>
    </form>

    <script>
      const form = document.getElementById("resetForm");
      const passwordInput = document.getElementById("password");
      const errorMsg = document.getElementById("errorMsg");
      const submitBtn = document.getElementById("submitBtn");
      const spinnerOverlay = document.getElementById("spinnerOverlay");
      let isSubmitting = false;

      // Función para mostrar el spinner y deshabilitar el botón
      function showLoading() {
        isSubmitting = true;
        spinnerOverlay.style.display = "flex";
        submitBtn.disabled = true;
        submitBtn.style.cursor = "not-allowed";
      }

      // Función para ocultar el spinner y habilitar el botón
      function hideLoading() {
        isSubmitting = false;
        spinnerOverlay.style.display = "none";
        submitBtn.disabled = false;
        submitBtn.style.cursor = "pointer";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault(); // evitar que se envíe el form directamente

        // Prevenir múltiples envíos
        if (isSubmitting) {
          return;
        }

        const password = passwordInput.value;

        // Regex para validar la contraseña
        const passwordRegex =
          /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;

        if (!passwordRegex.test(password)) {
          errorMsg.textContent =
            "La contraseña debe tener al menos 8 caracteres, una mayúscula, una minúscula, un número y un carácter especial";
          errorMsg.style.display = "block";
          return;
        }

        // Limpiar mensaje de error
        errorMsg.textContent = "";
        errorMsg.style.display = "none";

        // Mostrar spinner y deshabilitar botón
        showLoading();

        // Obtener el token de la URL
        const token = globalThis.location.pathname.split("/").pop();

        // Enviar la contraseña al backend
        try {
          const res = await fetch(`/api/auth/reset-password/${token}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password }),
          });

          if (res.ok) {
            // El servidor devuelve HTML directamente, recargar la página para mostrar el resultado
            const html = await res.text();
            document.open();
            document.write(html);
            document.close();
          } else {
            // Ocultar spinner antes de mostrar error
            hideLoading();

            // En caso de error, el servidor también devuelve HTML
            const html = await res.text();
            // Si es un error de validación (400), mostrar el mensaje
            if (res.status === 400) {
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, "text/html");
              const errorText =
                doc.querySelector("h2")?.textContent ||
                "Error al restablecer la contraseña";
              errorMsg.textContent = errorText;
              errorMsg.style.display = "block";
            } else {
              // Para otros errores, mostrar la página de error del servidor
              document.open();
              document.write(html);
              document.close();
            }
          }
        } catch (err) {
          // Ocultar spinner en caso de error
          hideLoading();
          errorMsg.textContent = "Error de conexión con el servidor";
          errorMsg.style.display = "block";
          console.error(err);
        }
      });
    </script>
  </body>
</html>
